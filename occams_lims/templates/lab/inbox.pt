<html i18n:domain="occams.studies" metal:use-macro="load:../master.pt">
  <metal:content-slot fill-slot="content-slot">

    <h1>${context.title}</h1>

    <nav metal:use-macro="load: header-nav.pt"></nav>

    <br />

    <form metal:use-macro="load: filter-specimen.pt"></form>

    <hr />

    <div class="well well-lg" tal:condition="not:has_specimen">
      <h3 i18n:translate="">No specimen found</h3>
      <p i18n:translate="">Please refine your search</p>
    </div>

    <form method="POST">
      <input type="hidden" name="csrf_token" value="${request.session.get_csrf_token()}">

      <table class="table table-bordered table-hover table-striped" tal:condition="has_specimen">
        <thead>
          <tr>
            <!-- TODO remove hardcoded styling -->
            <th style="width: 2%"><input type="checkbox" data-toggle='selectall'/></th>
            <th style="width: 4%" i18n:translate="">ID</th>
            <th style="width: 9%" i18n:translate="">State</th>
            <th style="width: 9%" i18n:translate="">Label Queue</th>
            <th style="width: 5%" i18n:translate="">Patient</th>
            <th style="width: 5%" i18n:translate="">Study/Cycle</th>
            <th style="width: 9%" i18n:translate="">Visit</th>
            <th style="width: 9%" i18n:translate="">Tube Type</th>
            <th style="width: 9%" i18n:translate="">Type</th>
            <th style="width: 4%" i18n:translate="">Tubes</th>
            <th style="width: 9%" i18n:translate="">Collect Date</th>
            <th style="width: 7%" i18n:translate="">Collect Time</th>
            <th style="width: 9%" i18n:translate="">Location</th>
            <th style="width: 10%" i18n:translate="">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tal:draw repeat="draw specimen">
            <tr tal:define="
              subform form.specimen.entries[repeat['draw'].index];
              disabled not:request.has_permission('process')">
              <td><tal:select condition="not:disabled">${subform.ui_selected(**{'data-toggle': 'select'})}</tal:select></td>
              <td><code>${draw.id}</code></td>
              <td><span tal:define="state draw.state" metal:use-macro="load: pretty-state.pt"></span></td>
              <td>${(draw.tubes and draw.tubes or 0) if draw.id in label_queue else None}</td>
              <td><code>${draw.patient.pid}</code></td>
              <td>${draw.cycle.study.short_title} - ${draw.cycle.week}</td>
              <td><code>${draw.visit_date}</code></td>
              <td>${draw.specimen_type.tube_type}</td>
              <td>${draw.specimen_type.title}</td>
              <td>
                ${subform.tubes(class_='form-control', disabled=disabled)}
                <div class="text-danger" tal:repeat="error subform.tubes.errors">${error}</div>
              </td>
              <td>
                ${subform.collect_date(class_='form-control js-date', placeholder='YYYY-MM-DD', disabled=disabled)}
                <div class="text-danger" tal:repeat="error subform.collect_date.errors">${error}</div>
              </td>
              <td>
                ${subform.collect_time(class_='form-control js-time', placeholder='HH:MM', disabled=disabled)}
                <div class="text-danger" tal:repeat="error subform.collect_time.errors">${error}</div>
              </td>
              <td>
                ${subform.location_id(class_='js-select2', disabled=disabled)}
                <div class="text-danger" tal:repeat="error subform.location_id.errors">${error}</div>
              </td>
              <td>
                ${subform.notes(class_='form-control', disabled=disabled)}
                <div class="text-danger" tal:repeat="error subform.notes.errors">${error}</div>
              </td>
            </tr>
          </tal:draw>
        <tbody>
      </table>

      <nav metal:use-macro="load: specimen-pager.pt"></nav>

      <div>

        <button
            type="submit"
            class="btn btn-default"
            name="queue"
            tal:attributes="disabled not:has_specimen"
            tal:condition="request.has_permission('process')"
            data-toggle="popover"
            data-trigger="hover"
            data-placement="top"
            data-content="Saves all changes, and then adds the selected specimen to the print queue"
            >Toggle Print Queue</button>
        <button
            type="button"
            class="btn btn-default"
            name="print"
            data-modal-remote="${request.current_route_path(_route_name='lims.lab_specimen_labels')}"
            data-modal-target="#modal-target"
            data-toggle="popover"
            data-trigger="hover"
            data-placement="top"
            data-content="Prints labels for the specimen in the print queue"
            tal:attributes="disabled not:has_labels_queued"
            tal:condition="request.has_permission('process')"
          >Print Labels</button>
        <button
            type="submit"
            class="btn btn-default"
            name="complete"
            tal:attributes="disabled not:has_specimen"
            tal:condition="request.has_permission('process')"
            data-toggle="popover"
            data-trigger="hover"
            data-placement="top"
            data-html="true"
            data-content="Saves all changes entered to the database (for all specimen). Then marks the selected specimen as complete. If the location you've entered for the items is the current lab, you will find them in <a href='${request.current_route_path(_route_name='lims.lab_batched')}'>batched</a>"
            >Complete Selected</button>
        <button
            type="submit"
            class="btn btn-default"
            name="cancel-draw"
            tal:attributes="disabled not:has_specimen"
            tal:condition="request.has_permission('process')"
            data-toggle="popover"
            data-trigger="hover"
            data-placement="top"
            data-content="Mark the selected specimen as undrawn"
            >Mark Selected Undrawn</button>
        <button
            type="button"
            class="btn btn-default"
            name="add"
            data-modal-remote="${request.current_route_path(_route_name='lims.lab_specimen_add')}"
            data-modal-target="#modal-target"
            data-toggle="popover"
            data-trigger="hover"
            data-placement="top"
            data-content="Adds a new specimen. This action DOES NOT save current changes."
            tal:condition="request.has_permission('process')"
            >Add Specimen</button>

        <button
            type="submit"
            class="btn btn-primary"
            name="save"
            tal:attributes="disabled not:has_specimen"
            tal:condition="request.has_permission('process')"
            data-toggle="popover"
            data-trigger="hover"
            data-placement="top"
            data-content="Saves all of the changes entered to the database. This applies to all specimen, not just selected specimen."
            >Save All Changes</button>

        </div>


    </form>

    <div id="modal-target" class="modal fade"></div>

  </metal:content-slot>
  <metal:content-slot fill-slot="javascript-extras-slot">
    <script>
      $(function () {
        $('[data-toggle="popover"]').popover();
        $('.js-select2').select2({allowClear: true});
        $('.js-date').datetimepicker({useCurrent: false, pickTime: false, format: 'YYYY-MM-DD'});
      })
    </script>
  </metal:content-slot>
</html>
