<html i18n:domain="occams.studies" metal:use-macro="load:../master.pt">
  <metal:content-slot fill-slot="content-slot">

    <h1>${context.title}</h1>

    <nav metal:use-macro="load: header-nav.pt"></nav>

    <br />

    <form metal:use-macro="load: filter-specimen.pt"></form>

    <hr />

    <div class="well well-lg" tal:condition="not:has_specimen">
      <h3 i18n:translate="">No specimen found</h3>
      <p i18n:translate="">Please refine your search</p>
    </div>

    <form method="POST">
      <input type="hidden" name="csrf_token" value="${request.session.get_csrf_token()}">

      <table class="table table-bordered table-hover table-striped" tal:condition="has_specimen">
        <thead>
          <tr>
            <!-- TODO remove hardcoded styling -->
            <th style="width: 2%"><input type="checkbox" data-toggle='selectall'/></th>
            <th style="width: 4%" i18n:translate="">ID</th>
            <th style="width: 9%" i18n:translate="">State</th>
            <th style="width: 5%" i18n:translate="">Patient</th>
            <th style="width: 5%" i18n:translate="">Study/Cycle</th>
            <th style="width: 9%" i18n:translate="">Tube Type</th>
            <th style="width: 9%" i18n:translate="">Type</th>
            <th style="width: 4%" i18n:translate="">Tubes</th>
            <th style="width: 9%" i18n:translate="">Collect Date</th>
            <th style="width: 7%" i18n:translate="">Collect Time</th>
            <th style="width: 10%" i18n:translate="">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tal:draw repeat="draw specimen">
            <tr tal:define="subform form.specimen.entries[repeat['draw'].index]">
              <td>${subform.ui_selected(**{'data-toggle': 'select'})}</td>
              <td><code>${draw.id}</code></td>
              <td><span tal:define="state draw.state" metal:use-macro="load: pretty-state.pt"></span></td>
              <td><code>${draw.patient.pid}</code></td>
              <td>${draw.cycle.study.short_title} - ${draw.cycle.week}</td>
              <td>${draw.specimen_type.tube_type}</td>
              <td>${draw.specimen_type.title}</td>
              <td>${draw.tubes}</td>
              <td><code>${draw.collect_date}</code></td>
              <td><code tal:condition="draw.collect_time">${draw.collect_time}</code></td>
              <td>${draw.notes}</td>
            </tr>
          </tal:draw>
        <tbody>
      </table>

      <nav metal:use-macro="load: specimen-pager.pt"></nav>

      <button
          type="submit"
          class="btn btn-default"
          name="pending-aliquot"
          tal:attributes="disabled not:has_specimen"
          data-toggle="popover"
          data-trigger="hover"
          data-placement="top"
          data-content="Begins the aliquot process"
          >Prepare Selected for Aliquot</button>
      <button
          type="submit"
          class="btn btn-default"
          name="cancel-draw"
          tal:attributes="disabled not:has_specimen"
          data-toggle="popover"
          data-trigger="hover"
          data-placement="top"
          data-content="Mark the selected specimen as cancelled"
          >Mark Selected Undrawn</button>
      <button
          type="button"
          class="btn btn-default"
          name="add"
          data-modal-remote="${request.current_route_path(_route_name='lims.lab_specimen_add')}"
          data-modal-target="#modal-target"
          data-toggle="popover"
          data-trigger="hover"
          data-placement="top"
          data-content="Adds a new specimen. This action DOES NOT save current changes."
          >Add Specimen</button>
    </form>


    <div id="modal-target" class="modal fade"></div>

  </metal:content-slot>
  <metal:content-slot fill-slot="javascript-extras-slot">
    <script>
      $(function () {
        $('[data-toggle="popover"]').popover();
        $('.js-select2').select2({allowClear: true});
        $('.js-date').datetimepicker({useCurrent: false, pickTime: false, format: 'YYYY-MM-DD'});
      })
    </script>
  </metal:content-slot>
</html>
